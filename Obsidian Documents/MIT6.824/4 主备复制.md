# 论文

先看vm-ft论文

脑裂：出现两个leader或者master或者coordinator.

# 复制方式

vm-ft讲了 ==两种主备复制的同步方式：==
- 状态转移：主服务器持续将所有状态（包括**CPU、内存和I/O设备**）变化发送给备份服务器。
- ==复制状态机(RSM)==：将备份状态机视为确定状态机（Deterministic State Machine，DSM）。然后主/备份服务器都以相同的初始状态启动，然后以相同的顺序接收并执行相同的输入请求，然后得到相同的输出，这样就可以保持两者状态的一致。**传输操作**
类似于redis两种持久化方式：RDB、AOF？

采用备份状态机会有一个问题，即对于真实物理机来讲，有些行为是不确定的（例如，中断，产生的随机数等），所以很难将行为看作是一个确定性（deterministic）的行为。
VMWare的解决方案是将所有操作虚拟化，并在VM和物理机之间加一个Hypervisor（虚拟机管理程序），然后就可以通过hypervisor让VM都能模拟成一个DSM运行，那么primary的所有操作都确定了，再通过Logging channel将这些操作传递到backup，然后backup进行replay，从而实现两者的高度一致。
具体是怎么将不确定的行为进行确定化操作的，它主要是进行了一个写日志的操作，主备服务器之间有日志通道来保证的，后续会详细解释。

两种方式分别传内存和客户端操作及外部事件。
6.824主要讲后者。

## 复制挑战

- 我们要复制哪些状态？
- 主机必须等待备机备份完吗？
- 什么时候切换到备机？
- 切换时能否看到异常情况？
- 如果有个副本故障了，我们需要重新添加一个新的副本，这可能是一个代价很高的行为，因为副本可能非常大，如何提升添加新副本的速度？

不确定性操作
需要在同样的指令号上进行中断。
使用输出规则来解决vm-ft失败场景，如自增，有点类似WAL。
主备出现网络分区时，如何处理脑裂现象。在storage中进行testandset。
primary/backup的存储不在本地，而在一个外部storage

## vm-ft做法

![](Pasted%20image%2020230716161802.png)
VMware FT 需要两台物理服务器，主机与备机保持同步，虚拟机的虚拟磁盘在共享存储上。

所有的输入(如网络、鼠标、键盘等)都会输入到主机，然后通过 Logging channel 转发到备机，对于非确定性的操作，还将发送额外的信息，确保备机以确定性的方式执行这些操作。

两台虚拟机都会执行输入操作，但**只有主机的输出会返回客户端，备机的输出会被管理程序丢弃**。

### FT协议

VMware FT 通过确定性重放来产生相关的日志条目，但不将日志写入磁盘，而是通过 logging channel 发送给备机。备机实时重放日志项。

	**输出要求**：如果备机在主机故障后接管，备机将以和主机已经向外界发送的输出完全一致的方式继续运行。
	**输出规则**：主机直到备机接收并确认了和输出相关的日志的时候，才发送输出给外界。、

### 脑裂问题

为了确保一次只有一个虚拟机成为主机，避免出现脑裂，VMware 在共享存储上执行一个原子的 `test-and-set` 锁指令。该操作每次只能对其中一台机器返回成功，这在主机和备机因为网络分区都想接替工作时很有用。