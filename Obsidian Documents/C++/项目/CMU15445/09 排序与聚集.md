
# 本节课内容

**将单个运行算（排序或者选择或者聚集）的执行方式**

![](Pasted%20image%2020230323150438.png)
前三节课是access methods
现在开始研究operater execution

![](Pasted%20image%2020230323150559.png)


![](Pasted%20image%2020230323150637.png)
假设查询结果很大不能放到内存中

![](Pasted%20image%2020230323150737.png)



![](Pasted%20image%2020230323150904.png)

![](Pasted%20image%2020230323151038.png)

# 外部归并排序

排硬盘里的数据
![](Pasted%20image%2020230323151127.png)
![](Pasted%20image%2020230323151218.png)
两种方式进行一次排序：
1. value为tuple   早物化
2. value为record id   晚物化

一张表可以分为多个页来存储
![](Pasted%20image%2020230323151531.png)

![](Pasted%20image%2020230323152516.png)
前两步内存中用到了两页，最后一步内存中用到了三页

八张页，最后一页是EOF
![](Pasted%20image%2020230323153258.png)

![](Pasted%20image%2020230323153353.png)
只用到了3页内存，如果工作io阻塞，无法充分利用缓存池。
优化：

![](Pasted%20image%2020230323153537.png)
1. 执行预取操作减少io
2. 多路归并排序
![](Pasted%20image%2020230323153659.png)
![](Pasted%20image%2020230323154037.png)
B-1是因为需要有一个用作输出缓存页

![](Pasted%20image%2020230323154237.png)
聚簇类似于早物化
非聚簇：叶子里面记录了行id或者主键需要回主表取字段。
![](Pasted%20image%2020230323154336.png)
![](Pasted%20image%2020230323154349.png)


# 聚集

![](Pasted%20image%2020230323154620.png)
两种聚集方法：
- 排序
- 哈希


## sorting aggregation

利用排序做聚集
![](Pasted%20image%2020230323154948.png)

## hashing aggregate

### 适用场景
- 无需排序，但是去重
- 分组，但不需要有序

![](Pasted%20image%2020230323155053.png)

![](Pasted%20image%2020230323155120.png)

### 算法：外部hash聚集

#### 步骤

- 分区hash
- rehash
- 
![](Pasted%20image%2020230323155154.png)
![](Pasted%20image%2020230323155210.png)

#### **举例**

![](Pasted%20image%2020230323155407.png)
在完成下层算子后，使用h1哈希函数将相同的值或者碰撞值放入同一hash桶中。并按分区进行落盘。落盘时可以提前做distinct。

==衍生面试题：很大文件怎么进行去重操作？？==

## rehash

### 原因

1. 第一次hash后文件仍然很大没法放入内存，进行第二次hash缩减大小放入内存
2. 有hash碰撞

### 步骤：

1. 对每个分区桶，使用h2函数进行第二次rehash，放入内存
2. 遍历第二次hash的每一个桶，将匹配元组聚集起来
![](Pasted%20image%2020230323155504.png)

第一个桶里面有哈希碰撞的
![](Pasted%20image%2020230323155545.png)
==上面讲的都是对于DISTINCT操作。==


###  HAVING操作

rehash阶段存储KV
![](Pasted%20image%2020230323155600.png)
value是中间值/聚集值。比如聚集函数AVG，value为个数和总和。

![](Pasted%20image%2020230323155718.png)

# 总结

![](Pasted%20image%2020230323155758.png)

- 两种聚集算法的选择情况：也要根据之前做的操作进行抉择，如果之前排好序了，那么直接使用sorting。
- sort优化分案：
	- 多个文件页组成大文件块。随机io变成顺序io
	- 增大缓存池。