![](Pasted%20image%2020230601172755.png)
![](Pasted%20image%2020230601173345.png)

# 课程内容

![](Pasted%20image%2020230601173412.png)

# 并行数据库系统架构

![](Pasted%20image%2020230601203228.png)
内存和磁盘资源是怎么分布的，怎么被cpu使用、

几种架构：
![](Pasted%20image%2020230601203559.png)

## 共享存储

多核/多个cpu。用的比较少
![](Pasted%20image%2020230601203629.png)

## 共享磁盘

![](Pasted%20image%2020230601204451.png)
存算分离。用的非常多。计算节点存储节点分开。逻辑上的大硬盘。淘宝的PolarDB用的这种架构。

### 举例

![](Pasted%20image%2020230601204943.png)
解耦，可以方便扩容，增加计算node。

### 问题

修改时修改的是node的缓存的数据，并不会实时刷进storage。因此其他node可以拿到旧数据。节点同步问题。
![](Pasted%20image%2020230601205203.png)

## 无共享

不方便扩容。
数据一致性更难保证，落盘都不一样。
性能类似单节点，比较高。
![](Pasted%20image%2020230601205343.png)

### 举例

不是一个统一的存储，必然面对数据分区问题。
![](Pasted%20image%2020230601205456.png)
计算节点和存储同时增加。

# 设计问题

![](Pasted%20image%2020230601210344.png)


![](Pasted%20image%2020230601210918.png)
- 同质节点：每个几点在集群中执行相同的任务，尽管负责的数据分区不一样
- 异质节点
![](Pasted%20image%2020230601211122.png)


数据透明
![](Pasted%20image%2020230601211144.png)


## 数据分区

数据分区/分片
![](Pasted%20image%2020230601211316.png)



数据分区怎么做？

### 简单分区

简单分区，按表分区。即一个节点一张表。
![](Pasted%20image%2020230601211449.png)
拉取一张表数据类似于单机数据库，但join难度非常大，负载均衡也不好。
![](Pasted%20image%2020230601211624.png)

### 水平分区（水平切表）

![](Pasted%20image%2020230601214836.png)
是分为逻辑分区和物理分区的


![](Pasted%20image%2020230601221921.png)
问题：查询的不是partition key的话会很麻烦，方便的是谓词为分区键。

扩容：
![](Pasted%20image%2020230601222140.png)
重新使用hash函数进行rehash。
问题：新挂盘后，所有数据跟着动（需要进行数据迁移），很长一段时间数据库性能差，数据迁移成本很高。

#### 解决：一致性hash算法

==面试常问==
解决问题：分布式系统扩容或者缩容时，发生过多的数据迁移问题。
![](Pasted%20image%2020230601223710.png)
将对2^32进行取模的结果组织成一个首尾相连的圆环，即哈希环。
一致性hash是将存储节点和数据都映射到一个首尾相连的hash环上。映射的结果值往**顺时针的方向的找到第一个节点**，就是存储该数据的节点。
因此，**在一致哈希算法中，如果增加或者移除一个节点，仅影响该节点在哈希环上顺时针相邻的后继节点，其它数据也不会受到影响**。

但是==一致性hash仍有负载不均衡问题。==
解决：使用两层映射。
具体做法是，**不再将真实节点映射到哈希环上，而是将虚拟节点映射到哈希环上，并将虚拟节点映射到实际节点，所以这里有「两层」映射关系。**

#### 逻辑分区

前面讲的都是物理分区。
sharing disk架构下只能逻辑分区。分的是每个节点负责的区。相当于负载均衡。
![](Pasted%20image%2020230601224523.png)

#### 物理分区

shared nothing架构。
![](Pasted%20image%2020230601224605.png)

# 分布式事务

![](Pasted%20image%2020230601224719.png)
需要协调分布式系统中的事务还有并发问题。

## 事务协调

![](Pasted%20image%2020230601224817.png)
协调事务的两种方案：
- 集中式
- 分布式

### 集中式协调器

#### 远程操作监控器

一个集中式的事务协调方案。
![](Pasted%20image%2020230601225425.png)
流程：
![](Pasted%20image%2020230601225524.png)
改进：使用中间件
![](Pasted%20image%2020230601225628.png)

### 分布式协调器

第一次找的节点成为本次事务的主节点,担负事务协调的职责。
![](Pasted%20image%2020230601225909.png)

## 分布式事务并发控制

![](Pasted%20image%2020230601230055.png)
可能的问题：
- 副本之间的同步
- 网络通信开销
- 节点挂了
- 节点时钟不同步

### 分布式2PL

死锁问题
![](Pasted%20image%2020230601230444.png)
中间是低速互联网连接。
![](Pasted%20image%2020230601230509.png)

# 总结

![](Pasted%20image%2020230601230521.png)
