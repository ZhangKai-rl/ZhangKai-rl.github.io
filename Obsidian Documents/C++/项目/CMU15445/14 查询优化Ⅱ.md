
![](Pasted%20image%2020230328140313.png)
- 使用代价模型评价
- 选出代价最小的

# 本节课内容

==这节课主要研究研究基于代价的   CBS==
![](Pasted%20image%2020230328140324.png)



# 代价模型的组成

![](Pasted%20image%2020230328140405.png)
- 物理代价
- 逻辑代价
- 算法代价

##  统计信息

统计信息（需要处理的数据信息）
![](Pasted%20image%2020230328140450.png)
![](Pasted%20image%2020230328140651.png)
NR：R表的行数
V（A, R）：R表中A属性的唯一值。

可推断统计信息
![](Pasted%20image%2020230328140938.png)
SC(A,R)：选择基数。对某一列进行选择，平均每个值出现的次数。等于NR / V(A, R)。

## 逻辑代价

![](Pasted%20image%2020230520150808.png)
唯一列上的等式谓词好估计SC。复杂谓词就不好估计。

#### 复杂谓词下统计信息

因此引出新的统计信息：选择率selectivity（sel）。
不同类型谓词公式不一样。
![](Pasted%20image%2020230520151032.png)
![](Pasted%20image%2020230520151719.png)
![](Pasted%20image%2020230520151909.png)
sel（not P) = 1 - sel(P)
思考：有点类似于概率
![](Pasted%20image%2020230520152017.png)
独立性假设的情况下直接相乘。
![](Pasted%20image%2020230520152102.png)


### join代价评价

![](Pasted%20image%2020230520152312.png)
![](Pasted%20image%2020230520152436.png)
第二个是反过来进行join的情况

#### 问题

做了三个假设
![](Pasted%20image%2020230520152831.png)
![](Pasted%20image%2020230520153901.png)
井号是numbers的意思。表属性之间有密切关系，也就是不独立的情况。

### 不独立情况下cost estimations

![](Pasted%20image%2020230520154702.png)
不均匀情况更常见
![](Pasted%20image%2020230520154749.png)

#### 记录列属性唯一值数量

##### 直方图

等宽直方图
![](Pasted%20image%2020230520154837.png)
如7 8 差距很大，此时误差很大

等深直方图
![](Pasted%20image%2020230520154932.png)
![](Pasted%20image%2020230520154944.png)

##### sketch记录

![](Pasted%20image%2020230520155108.png)
- hypterloglog ：redis使用，hash值第一个1出现的位置。

##### SAMPING

![](Pasted%20image%2020230520155435.png)
问题：要创建并维护小表

>思考

![](Pasted%20image%2020230520155534.png)
我们现在可以大概估计谓词选择性了，知道每个算子送进去多少数据输出多少数据，据此我们可以进行代价计算，那么我们用代价来干嘛呢？

# 查询优化计划列举

![](Pasted%20image%2020230520180421.png)
有些基于启发的做不了

## 单表查询

![](Pasted%20image%2020230520180528.png)
![](Pasted%20image%2020230520180823.png)
只用启发性优化即可

## 多表

多表join
![](Pasted%20image%2020230520180930.png)
![](Pasted%20image%2020230520180954.png)
左深树：只允许左边是join，如图1
![](Pasted%20image%2020230520181310.png)
左深树好处：流式计划，无需存储中间结果

![](Pasted%20image%2020230520181435.png)
使用动态规划

### 举例

动态规划计算开销处理优化
![](Pasted%20image%2020230520182824.png)
![](Pasted%20image%2020230520182853.png)
![](Pasted%20image%2020230520182942.png)



![](Pasted%20image%2020230520183031.png)
![](Pasted%20image%2020230520183042.png)
谓词里面没有连接列时使用笛卡尔积。笛卡尔积开销太大

针对每种连接顺序枚举连表算法
![](Pasted%20image%2020230520183221.png)

列举每个表的读表方式
![](Pasted%20image%2020230520183305.png)

# 实际案例

![](Pasted%20image%2020230520183400.png)

## PG遗传算法

一般12张表以上采用

1. 随机选3个方案，淘汰最差的
2. 剩下两个做突变，在随机生成一个方案
3. 循环一直到优化时间或代数
![](Pasted%20image%2020230520183714.png)


# 总结

![](Pasted%20image%2020230520183811.png)