# 解决问题

![](Pasted%20image%2020230321164852.png)

![](Pasted%20image%2020230321143627.png)
在表索引上应用广泛。
表索引是表列的冗余副本
![](Pasted%20image%2020230321143822.png)
要考虑索引的存储和维护负载

# 本节课内容

![](Pasted%20image%2020230321143945.png)

![](Pasted%20image%2020230321143959.png)

![](Pasted%20image%2020230321144142.png)

![](Pasted%20image%2020230321151027.png)
b+树是m路查找树。
特征：
- 完美平衡，叶子都在同一层了。
- 除根节点外，节点至少半满。假设一个结点的degree为M（最多可以有M个pointer，M-1个key），最少M/2-1个key，pointer？
指针指向的是叶子结点的地址
![](Pasted%20image%2020230321151401.png)
value一般为主键id
degree是节点的度数
![](Pasted%20image%2020230321151740.png)
degree=4，最多有四个子节点，那么每个节点key的个数<=degree - 1
sql中叶子是双向链表，包含所有数据。
![](Pasted%20image%2020230321152048.png)
- 所有节点是一对key valule对
- ==key是要索引的值，要对年龄进行索引key就是年龄
value：分中间和叶子。中间为下一层孩子的地址，叶子为行的id或者地址（RID）==
- 每个节点中的数据是有序的。

# hash vs b+：

- 哈希表天然是不分块的，但实际存储时是存储到一个个块中，哈希需要考虑块的大小。
- b+树可以控制一个节点就是存储的一个页的大小。按照节点为单位存取文件。逻辑结构与物理结构相同。数据结构里面是一个节点，物理存储结构上是一页。



叶子节点内部结构（假如按页存）
![](Pasted%20image%2020230321152912.png)
实际物理存
![](Pasted%20image%2020230321152959.png)

# 叶子值类型

![](Pasted%20image%2020230321153013.png)
value存：
	1. 行id（指针），主键id或者指向tuple的指针； RID。非聚簇索引
	2. 整个行的tuple 数据（如key是主键的时候）。聚簇索引

==InnoDB的默认数据结构是聚簇索引，而MyISAM是非聚簇索引==
![](Pasted%20image%2020230321153721.png)
聚簇索引page中的tuple按照pk顺序存储。

# B vs B+
![](Pasted%20image%2020230321153303.png)
b树中间节点也存数据
b+树中间节点只是索引的作用

![](Pasted%20image%2020230321153421.png)
复合键   跳跃搜索

![](Pasted%20image%2020230321162512.png)
![](Pasted%20image%2020230321162535.png)


# 重复键

- 组合key
- 专门碰撞的叶子节点
![](Pasted%20image%2020230321162617.png)
重复key解决办法
![](Pasted%20image%2020230321162715.png)
![](Pasted%20image%2020230321162731.png)
开辟一个专门放碰撞的叶子节点

# 聚簇与非聚簇索引

![](Pasted%20image%2020230321162754.png)
聚簇索引
数据是不是按主键索引组织的。数据聚集在主键索引里面就是聚簇索引
![](Pasted%20image%2020230321162907.png)
数据在磁盘上的顺序和在叶子结点上的顺序对应
非聚簇
![](Pasted%20image%2020230321162941.png)
在磁盘上的顺序(可能按pk)和节点上顺序不一样
利用局部性原理可以先缓存上，然后来读取数据



![](Pasted%20image%2020230321163153.png)
权衡速度和冗余数据
mysql为16kb跟页大小相同

AP全表查询需要结点大。
TP点查询需要结点小。

![](Pasted%20image%2020230321163423.png)
结点合并阈值
会延迟合并


# 变长key解决

![](Pasted%20image%2020230321163508.png)
变长key
1. 存指针，这样就一样长了
2. 使用变长结点。不推荐
3. 补长
4. 存个槽 k - v

mysql一条数据不能超过一个页的大小

![](Pasted%20image%2020230321163830.png)
结点内部的搜索
1. 线性
2. 二分查找

# 优化

![](Pasted%20image%2020230321164129.png)
优化